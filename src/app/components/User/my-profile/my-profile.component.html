<!-- src/app/components/User/my-profile/my-profile.component.html -->
<ng-container *ngIf="state$ | async as state">
  <div class="profile-page-wrapper">
    <!-- Loading State -->
    <div *ngIf="state.isLoading" class="status-container">
      <div class="loader"></div>
      <p>Loading Profile...</p>
    </div>

    <!-- Error/Success Toasts -->
    <div *ngIf="state.error" class="toast error-toast">{{ state.error }}</div>
    <div *ngIf="state.success" class="toast success-toast">{{ state.success }}</div>

    <!-- Main Content -->
    <div *ngIf="state.profile && !state.isLoading" class="profile-layout-grid animate-fade-in">
      <!-- Left Sidebar -->
      <aside class="profile-sidebar">
        <div class="avatar-container">
          <img [src]="getAvatarUrl(state.profile)" *ngIf="getAvatarUrl(state.profile)" alt="User Avatar" class="profile-avatar-img">
          <div *ngIf="!getAvatarUrl(state.profile)" class="avatar-placeholder">
            <span>{{ state.profile.firstName.charAt(0) }}</span>
          </div>
          <div class="online-indicator"></div>
        </div>
        <h1 class="user-name">{{ state.profile.firstName }} {{ state.profile.lastname }}</h1>
        <p class="user-role">{{ getRoleAsString(state.profile.role) }}</p>
        <button class="logout-btn-sidebar" (click)="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </aside>

      <!-- Right Main Content -->
      <main class="profile-main-content">
        <!-- User Information Card -->
        <section class="info-card">
          <h2 class="card-title"><i class="fas fa-user-circle"></i> Personal Information</h2>
          <div class="info-grid">
            <div class="info-item"><label><i class="fas fa-user"></i> Full Name</label><span>{{ state.profile.firstName }} {{ state.profile.middleName }} {{ state.profile.lastname }}</span></div>
            <div class="info-item"><label><i class="fas fa-envelope"></i> Email Address</label><span>{{ state.profile.email }}</span></div>
            <div class="info-item"><label><i class="fas fa-venus-mars"></i> Gender</label><span>{{ getGenderAsString(state.profile.gender) }}</span></div>
          </div>
        </section>

        <!-- Academic Info (Students Only) -->
        <section class="info-card" *ngIf="state.profile.role === 0">
          <h2 class="card-title"><i class="fas fa-graduation-cap"></i> Academic Information</h2>
          <div class="info-grid">
            <div class="info-item"><label><i class="fas fa-calendar-alt"></i> Graduation Date</label><span>{{ formatGraduationDate(state.profile.graduationDate) }}</span></div>
          </div>
        </section>

        <!-- Actions Card -->
        <section class="info-card">
          <h2 class="card-title"><i class="fas fa-cog"></i> Account Actions</h2>
          <div class="actions-grid">
            <button class="action-btn" (click)="toggleEditProfileForm(state.profile!)"><i class="fas fa-edit"></i><span>Edit Profile</span></button>
            <button class="action-btn" (click)="toggleChangePasswordForm()"><i class="fas fa-key"></i><span>Change Password</span></button>
          </div>
        </section>

        <!-- Edit Profile Form (Conditional) -->
        <section *ngIf="showEditProfileForm" class="info-card form-card">
          <h2 class="card-title">Edit Profile</h2>
          <form [formGroup]="editProfileForm" (ngSubmit)="onUpdateProfile()">
            <div class="form-group avatar-upload-group">
              <label>Profile Photo</label>
              <button type="button" class="action-btn-secondary" (click)="triggerFileInput()">Change Photo</button>
              <input type="file" #avatarFileInput hidden accept="image/*" (change)="onFileSelected($event)">
              <p *ngIf="selectedAvatarFile" class="file-info">Selected: {{ selectedAvatarFile.name }}</p>
            </div>
            <div class="form-grid">
              <div class="form-group"><label for="firstName">First Name</label><input id="firstName" formControlName="firstName" class="form-control"></div>
              <div class="form-group"><label for="lastname">Last Name</label><input id="lastname" formControlName="lastname" class="form-control"></div>
              <div class="form-group"><label for="middleName">Middle Name</label><input id="middleName" formControlName="middleName" class="form-control"></div>
              <div class="form-group"><label for="email">Email</label><input id="email" type="email" formControlName="email" class="form-control"></div>
              <div class="form-group"><label for="gender">Gender</label>
                <select id="gender" formControlName="gender" class="form-control">
                  <option [ngValue]="null">Select Gender</option>
                  <option [ngValue]="0">Male</option>
                  <option [ngValue]="1">Female</option>
                </select>
              </div>
              <div class="form-group" *ngIf="state.profile?.role === 0">
                <label for="graduationDate">Graduation Date</label>
                <input id="graduationDate" type="date" formControlName="graduationDate" class="form-control">
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="submit-btn" [disabled]="editProfileForm.invalid">Save Changes</button>
              <button type="button" class="cancel-btn" (click)="toggleEditProfileForm(state.profile!)">Cancel</button>
            </div>
          </form>
        </section>

        <!-- Change Password Form (Conditional) -->
        <section *ngIf="showChangePasswordForm" class="info-card form-card">
          <h2 class="card-title">Change Password</h2>
          <form [formGroup]="changePasswordForm" (ngSubmit)="onChangePassword()">
            <div class="form-group"><label for="currentPassword">Current Password</label><input id="currentPassword" type="password" formControlName="currentPassword" class="form-control"></div>
            <div class="form-group"><label for="newPassword">New Password</label><input id="newPassword" type="password" formControlName="newPassword" class="form-control"></div>
            <div class="form-group"><label for="confirmNewPassword">Confirm New Password</label><input id="confirmNewPassword" type="password" formControlName="confirmNewPassword" class="form-control">
              <div *ngIf="changePasswordForm.hasError('mismatch') && changePasswordForm.get('confirmNewPassword')?.touched" class="invalid-feedback">Passwords do not match.</div>
            </div>
            <div class="form-actions">
              <button type="submit" class="submit-btn" [disabled]="changePasswordForm.invalid">Update Password</button>
              <button type="button" class="cancel-btn" (click)="toggleChangePasswordForm()">Cancel</button>
            </div>
          </form>
        </section>
      </main>
    </div>
  </div>
</ng-container>
