<!-- src/app/components/User/user-analytics/user-analytics.component.html -->
<ng-container *ngIf="state$ | async as state">
  <main class="analytics-container">
    <header class="page-header">
      <div class="header-content">
        <h1>User Intelligence</h1>
        <p>A deep-dive into user behavior, demographics, and activity patterns.</p>
      </div>
      <div class="header-filters">
        <div class="filter-group">
          <label for="role-filter">Role</label>
          <select id="role-filter" (change)="onRoleFilterChange($event)">
            <option value="all">All Roles</option>
            <option value="admin">Admin</option>
            <option value="student">Student</option>
            <option value="doctor">Doctor</option>
          </select>
        </div>
        <!-- ✅ FIX: Removed the non-functional status filter -->
      </div>
    </header>

    <ng-container *ngIf="state.isLoading">
      <div class="analytics-grid skeleton-grid">
        <div class="kpi-card-skeleton" *ngFor="let i of [1,2,3,4]"></div>
        <div class="chart-card-skeleton large"></div>
        <div class="chart-card-skeleton large"></div>
        <div class="chart-card-skeleton full-width"></div>
      </div>
    </ng-container>

    <div *ngIf="state.error && !state.isLoading" class="error-message">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>Loading Failed</h3>
      <p>{{ state.error }}</p>
    </div>

    <ng-container *ngIf="!state.isLoading && !state.error">
      <div *ngIf="filteredUsers$ | async as users">
        <ng-container *ngIf="kpiData$ | async as kpiData">
          <div class="analytics-grid">

            <!-- ✅ FIX: Updated KPI Cards to reflect real data -->
            <div class="kpi-card">
              <i class="fas fa-users kpi-icon"></i>
              <div class="kpi-content">
                <span class="kpi-value" #kpiValue [attr.data-value]="kpiData.total">0</span>
                <span class="kpi-title">Total Users</span>
              </div>
            </div>
            <div class="kpi-card">
              <i class="fas fa-user-graduate kpi-icon"></i>
              <div class="kpi-content">
                <span class="kpi-value" #kpiValue [attr.data-value]="kpiData.students">0</span>
                <span class="kpi-title">Total Students</span>
              </div>
            </div>
            <div class="kpi-card">
              <i class="fas fa-user-tie kpi-icon"></i>
              <div class="kpi-content">
                <span class="kpi-value" #kpiValue [attr.data-value]="kpiData.doctors">0</span>
                <span class="kpi-title">Total Doctors</span>
              </div>
            </div>
            <div class="kpi-card">
              <i class="fas fa-user-shield kpi-icon"></i>
              <div class="kpi-content">
                <span class="kpi-value" #kpiValue [attr.data-value]="kpiData.admins">0</span>
                <span class="kpi-title">Total Admins</span>
              </div>
            </div>

            <!-- Role Distribution Chart -->
            <div class="chart-card large">
              <h3 class="chart-title">Role Distribution</h3>
              <div *ngIf="roleDistributionOptions$ | async as options" class="chart-wrapper">
                <apx-chart [series]="options.series" [chart]="options.chart" [labels]="options.labels" [colors]="options.colors" [legend]="options.legend" [plotOptions]="options.plotOptions"></apx-chart>
              </div>
            </div>

            <!-- ✅ FIX: Replaced Signups chart with Gender Distribution chart -->
            <div class="chart-card large">
                <h3 class="chart-title">Gender Distribution</h3>
                <div *ngIf="genderDistributionOptions$ | async as options" class="chart-wrapper">
                  <apx-chart [series]="options.series" [chart]="options.chart" [labels]="options.labels" [colors]="options.colors" [legend]="options.legend" [tooltip]="options.tooltip"></apx-chart>
                </div>
            </div>

            <!-- Email Domain Chart -->
            <div class="chart-card full-width">
              <h3 class="chart-title">Top 5 Email Domains</h3>
               <div *ngIf="emailDomainOptions$ | async as options" class="chart-wrapper">
                <apx-chart [series]="options.series" [chart]="options.chart" [plotOptions]="options.plotOptions" [xaxis]="options.xaxis" [yaxis]="options.yaxis" [legend]="options.legend"></apx-chart>
              </div>
            </div>

          </div>
        </ng-container>
      </div>
    </ng-container>
  </main>
</ng-container>
