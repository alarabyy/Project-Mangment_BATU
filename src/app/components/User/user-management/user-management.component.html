<!-- src/app/components/User/user-management/user-management.component.html -->
<div class="user-management-container">
  <div *ngIf="successMessage" class="feedback-message success-message">
    <i class="fas fa-check-circle"></i> {{ successMessage }}
  </div>
  <div *ngIf="errorMessage" class="feedback-message error-message">
    <i class="fas fa-times-circle"></i> {{ errorMessage }}
  </div>

  <div class="page-header">
    <div class="header-content">
      <h1>User Management</h1>
      <p>Manage all registered users, view their details, and perform administrative actions.</p>
    </div>
    <div class="header-actions">
      <button class="btn-primary" (click)="goToUserAnalytics()">
        <i class="fas fa-chart-line"></i> User Analytics
      </button>
    </div>
  </div>

  <div class="search-bar">
    <input type="text" placeholder="Search users by name, email or role..." (input)="onSearch($event)" class="form-control" />
  </div>

  <ng-container *ngIf="state$ | async as state">
    <div *ngIf="state.isLoading" class="loading-spinner state-message">
      <div class="loader"></div> <p>Loading users...</p>
    </div>
    <div *ngIf="state.error" class="error-message state-message">
      <!-- Error content -->
    </div>

    <ng-container *ngIf="!state.isLoading && !state.error">
      <ng-container *ngIf="filteredUsers$ | async as users">
        <div *ngIf="users.length === 0" class="no-users-message state-message">
          <!-- No users content -->
        </div>

        <div class="table-responsive" *ngIf="users.length > 0">
          <table class="user-table">
            <thead>
              <tr>
                <th class="column-avatar">Avatar</th>
                <th class="column-name">Name</th>
                <th class="column-email">Email</th>
                <th class="column-role">Role</th>
                <th class="column-grad-date">Graduation Date</th>
                <th class="column-actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let user of users; trackBy: trackById">
                <!-- View Mode -->
                <tr *ngIf="editingUserId !== user.id">
                  <td data-label="Avatar">
                    <div class="user-avatar">
                      <!-- ✅ FIX: Calling the new component method on error -->
                      <img [src]="user.imageUrl" (error)="handleImageError($event)" alt="Avatar"/>
                      <i class="fas fa-user-circle fallback-icon"></i>
                    </div>
                  </td>
                  <td data-label="Name">{{ user.firstName }} {{ user.lastname }}</td>
                  <td data-label="Email">{{ user.email }}</td>
                  <td data-label="Role">
                    <span class="role-badge" [ngClass]="getRoleInfo(user.role).class">
                      <i class="fas" [ngClass]="getRoleInfo(user.role).icon"></i>
                      {{ getRoleInfo(user.role).name }}
                    </span>
                  </td>
                  <td data-label="Graduation Date">{{ formatGraduationDate(user) }}</td>
                  <td class="actions" data-label="Actions">
                    <button (click)="startEdit(user)" class="btn-action btn-edit"><i class="fas fa-edit"></i> Edit</button>
                    <button *ngIf="isAdmin()" (click)="deleteUser(user.id)" class="btn-action btn-delete"><i class="fas fa-trash-alt"></i> Delete</button>
                  </td>
                </tr>
                <!-- Edit Mode -->
                <tr *ngIf="editingUserId === user.id">
                  <td data-label="Avatar">
                    <div class="user-avatar">
                      <!-- ✅ FIX: Calling the new component method on error -->
                      <img [src]="editedUser?.imageUrl" (error)="handleImageError($event)" alt="Avatar"/>
                      <i class="fas fa-user-circle fallback-icon"></i>
                    </div>
                  </td>
                  <td data-label="Name"><input type="text" [(ngModel)]="editedUser!.firstName" /> <input type="text" [(ngModel)]="editedUser!.lastname" /></td>
                  <td data-label="Email"><input type="email" [(ngModel)]="editedUser!.email" /></td>
                  <td data-label="Role">
                    <span class="role-badge" [ngClass]="getRoleInfo(user.role).class">{{ getRoleInfo(user.role).name }}</span>
                  </td>
                  <td data-label="Graduation Date">{{ formatGraduationDate(user) }}</td>
                  <td class="actions" data-label="Actions">
                    <button (click)="saveEdit()" class="btn-action btn-save"><i class="fas fa-save"></i> Save</button>
                    <button (click)="cancelEdit()" class="btn-action btn-cancel"><i class="fas fa-times"></i> Cancel</button>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </ng-container>
    </ng-container>
  </ng-container>
</div>
