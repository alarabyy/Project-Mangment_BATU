<!-- src/app/components/project/project-analysis/project-analysis.component.html -->
<ng-container *ngIf="state$ | async as state">
  <main class="analytics-container">
    <header class="page-header">
      <div class="header-content">
        <h1>Project Analysis Dashboard</h1>
        <p>In-depth insights into project technologies and tools.</p>
      </div>
    </header>

    <ng-container *ngIf="state.isLoading">
      <div class="analytics-grid skeleton-grid">
        <div class="kpi-card-skeleton" *ngFor="let i of [1,2,3,4]"></div>
        <div class="chart-card-skeleton large"></div>
        <div class="chart-card-skeleton large"></div>
      </div>
    </ng-container>

    <div *ngIf="state.error && !state.isLoading" class="error-message">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>Loading Failed</h3>
      <p>{{ state.error }}</p>
      <button class="btn btn-primary" (click)="ngOnInit()">Retry</button>
    </div>

    <ng-container *ngIf="!state.isLoading && !state.error">
      <ng-container *ngIf="kpiData$ | async as kpiData">
        <div class="analytics-grid">

          <!-- KPI Cards -->
          <div class="kpi-card">
            <div class="icon-wrapper total"><i class="fas fa-project-diagram"></i></div>
            <div class="kpi-content"><span class="kpi-value" #kpiValue [attr.data-value]="kpiData.total">0</span><span class="kpi-title">Total Projects</span></div>
          </div>
          <div class="kpi-card">
            <div class="icon-wrapper tech"><i class="fas fa-microchip"></i></div>
            <div class="kpi-content"><span class="kpi-value" #kpiValue [attr.data-value]="kpiData.uniqueTech">0</span><span class="kpi-title">Unique Technologies</span></div>
          </div>
          <div class="kpi-card">
            <div class="icon-wrapper tools"><i class="fas fa-tools"></i></div>
            <div class="kpi-content"><span class="kpi-value" #kpiValue [attr.data-value]="kpiData.uniqueTools">0</span><span class="kpi-title">Unique Tools</span></div>
          </div>
          <div class="kpi-card">
            <div class="icon-wrapper length"><i class="fas fa-text-width"></i></div>
            <div class="kpi-content"><span class="kpi-value" #kpiValue [attr.data-value]="kpiData.avgTitleLength">0</span><span class="kpi-title">Avg. Title Length</span></div>
          </div>

          <!-- Top Technologies Chart -->
          <div class="chart-card large">
            <h3 class="chart-title">Top Technologies Used</h3>
            <div *ngIf="topTechnologiesOptions$ | async as options" class="chart-wrapper">
              <apx-chart [series]="options.series!" [chart]="options.chart!" [plotOptions]="options.plotOptions!" [xaxis]="options.xaxis!" [yaxis]="options.yaxis!" [legend]="options.legend!" [tooltip]="options.tooltip"></apx-chart>
            </div>
          </div>

          <!-- Top Tools Used Chart -->
          <div class="chart-card large">
            <h3 class="chart-title">Top Tools Used</h3>
            <div *ngIf="topToolsOptions$ | async as options" class="chart-wrapper">
              <apx-chart [series]="options.series!" [chart]="options.chart!" [plotOptions]="options.plotOptions!" [xaxis]="options.xaxis!" [yaxis]="options.yaxis!" [legend]="options.legend!" [tooltip]="options.tooltip"></apx-chart>
            </div>
          </div>

          <!-- Projects by Selected Item -->
          <ng-container *ngIf="{ selectedProjects: selectedItemProjects$ | async, selectedItem: clickedItem$ | async } as data">
            <ng-container *ngIf="data.selectedItem as item">
              <div class="selected-tech-projects-section">
                <div class="section-header">
                  <h3 class="chart-title">Projects Using: {{ item.name }}</h3>
                  <button class="btn btn-secondary" (click)="clearSelection()"><i class="fas fa-times"></i> Clear</button>
                </div>
                <div *ngIf="data.selectedProjects && data.selectedProjects.length > 0; else noProjects" class="tech-projects-grid">
                  <div class="project-card" *ngFor="let project of data.selectedProjects">
                    <h4 class="project-title">{{ project.title }}</h4>
                    <p class="project-description">{{ project.description | slice:0:120 }}...</p>
                  </div>
                </div>
                <ng-template #noProjects>
                  <div class="no-projects-message">No projects found for the selected item.</div>
                </ng-template>
              </div>
            </ng-container>
          </ng-container>
        </div>
      </ng-container>
    </ng-container>
  </main>
</ng-container>
