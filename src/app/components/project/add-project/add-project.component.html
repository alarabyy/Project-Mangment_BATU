<!-- src/app/components/project/add-project/add-project.component.html -->
<main class="container">
  <header class="page-header">
    <div class="header-icon"><i class="fas fa-plus-circle"></i></div>
    <div class="header-content"><h1>Create New Project</h1><p>Fill out the form below to add a new project.</p></div>
  </header>

  <form [formGroup]="projectForm" (ngSubmit)="onSubmit()" novalidate>
    <!-- Project Details Card -->
    <div class="form-card">
      <h2 class="card-title">Project Details</h2>
      <div class="form-grid">
        <div class="form-group span-2">
          <label for="title">Project Title</label>
          <input id="title" formControlName="title" class="form-control" [class.is-invalid]="f['title'].invalid && f['title'].touched">
          <div *ngIf="f['title'].invalid && f['title'].touched" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <span *ngIf="f['title'].errors?.['required']">Project title is required.</span>
            <span *ngIf="f['title'].errors?.['minlength']">Title must be at least 3 characters.</span>
          </div>
        </div>
        <div class="form-group span-2"><label for="description">Description</label><textarea id="description" formControlName="description" rows="4" class="form-control" [class.is-invalid]="f['description'].invalid && f['description'].touched"></textarea>
          <div *ngIf="f['description'].invalid && f['description'].touched" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <span *ngIf="f['description'].errors?.['required']">Description is required.</span>
            <span *ngIf="f['description'].errors?.['minlength']">Must be at least 10 characters.</span>
          </div>
        </div>
        <div class="form-group span-2"><label for="problemStatement">Problem Statement</label><textarea id="problemStatement" formControlName="problemStatement" rows="4" class="form-control" [class.is-invalid]="f['problemStatement'].invalid && f['problemStatement'].touched"></textarea>
          <div *ngIf="f['problemStatement'].invalid && f['problemStatement'].touched" class="error-message">
            <i class="fas fa-exclamation-circle"></i> Problem statement is required.
          </div>
        </div>

        <div class="form-group dropdown-group span-2">
          <label>Technologies</label>
          <div class="dropdown">
            <button type="button" class="dropdown-toggle" [class.is-invalid]="technologiesArray.invalid && technologiesArray.touched">Select Technologies</button>
            <div class="dropdown-menu" formArrayName="technologies">
              <div *ngFor="let tech of availableTechnologies; let i = index" class="dropdown-item">
                <input type="checkbox" [id]="'tech' + i" [formControlName]="i"><label [for]="'tech' + i">{{ tech }}</label>
              </div>
            </div>
          </div>
          <div class="selected-items">
            <span *ngFor="let item of getSelectedItems(availableTechnologies, technologiesArray)" class="item-badge">
              {{ item }} <button type="button" (click)="removeItem(availableTechnologies.indexOf(item), technologiesArray)">&times;</button>
            </span>
          </div>
           <div *ngIf="technologiesArray.invalid && technologiesArray.touched" class="error-message">
            <i class="fas fa-exclamation-circle"></i> At least one technology must be selected.
          </div>
        </div>

        <div class="form-group dropdown-group span-2">
          <label>Tools Used</label>
          <div class="dropdown">
            <button type="button" class="dropdown-toggle" [class.is-invalid]="toolsUsedArray.invalid && toolsUsedArray.touched">Select Tools</button>
            <div class="dropdown-menu" formArrayName="toolsUsed">
              <div *ngFor="let tool of availableTools; let i = index" class="dropdown-item">
                <input type="checkbox" [id]="'tool' + i" [formControlName]="i"><label [for]="'tool' + i">{{ tool }}</label>
              </div>
            </div>
          </div>
          <div class="selected-items">
            <span *ngFor="let item of getSelectedItems(availableTools, toolsUsedArray)" class="item-badge">
              {{ item }} <button type="button" (click)="removeItem(availableTools.indexOf(item), toolsUsedArray)">&times;</button>
            </span>
          </div>
          <div *ngIf="toolsUsedArray.invalid && toolsUsedArray.touched" class="error-message">
            <i class="fas fa-exclamation-circle"></i> At least one tool must be selected.
          </div>
        </div>

        <div class="form-group"><label for="categoryId">Category</label>
          <select id="categoryId" formControlName="categoryId" class="form-control" [class.is-invalid]="f['categoryId'].invalid && f['categoryId'].touched">
            <option [ngValue]="null" disabled>Select a Category</option>
            <option *ngFor="let cat of categories" [value]="cat.id">{{cat.name}}</option>
          </select>
          <div *ngIf="f['categoryId'].invalid && f['categoryId'].touched" class="error-message"><i class="fas fa-exclamation-circle"></i> Category is required.</div>
        </div>
        <div class="form-group"><label for="score">Final Score (Optional)</label><input id="score" type="number" formControlName="score" class="form-control" [class.is-invalid]="f['score'].invalid && f['score'].touched">
          <div *ngIf="f['score'].invalid && f['score'].touched" class="error-message"><i class="fas fa-exclamation-circle"></i> Score must be between 0 and 100.</div>
        </div>
      </div>
    </div>

    <div class="form-card">
        <h2 class="card-title">Departments</h2>
        <div class="checkbox-group" formArrayName="departments" [class.is-invalid]="departmentsArray.invalid && departmentsArray.touched">
          <div *ngFor="let dept of departments; let i = index" class="checkbox-item">
            <input type="checkbox" [id]="'dept' + i" [formControlName]="i"><label [for]="'dept' + i">{{ dept.name }}</label>
          </div>
        </div>
        <div *ngIf="departmentsArray.invalid && departmentsArray.touched" class="error-message"><i class="fas fa-exclamation-circle"></i> At least one department must be selected.</div>
    </div>

    <div class="form-card">
      <h2 class="card-title">Patent Information (Optional)</h2>
      <div class="form-grid">
        <div class="form-group"><label for="patentNumber">Patent Number</label><input id="patentNumber" type="number" formControlName="patentNumber" class="form-control"></div>
        <div class="form-group"><label for="patentDate">Patent Date</label><input id="patentDate" type="date" formControlName="patentDate" class="form-control"></div>
      </div>
    </div>

    <div class="form-card" formArrayName="members">
      <h2 class="card-title">Team Members</h2>
      <div *ngFor="let memberGroup of members.controls; let i = index" [formGroupName]="i" class="array-group">
        <div class="form-grid-3">
          <div class="form-group"><label [for]="'memberName' + i">Member Name</label><input [id]="'memberName' + i" formControlName="name" class="form-control" [class.is-invalid]="memberGroup.get('name')?.invalid && memberGroup.get('name')?.touched">
            <div *ngIf="memberGroup.get('name')?.invalid && memberGroup.get('name')?.touched" class="error-message"><i class="fas fa-exclamation-circle"></i> Name is required.</div>
          </div>
          <div class="form-group"><label [for]="'academicId' + i">Academic ID</label><input [id]="'academicId' + i" type="number" formControlName="academicId" class="form-control" [class.is-invalid]="memberGroup.get('academicId')?.invalid && memberGroup.get('academicId')?.touched">
            <div *ngIf="memberGroup.get('academicId')?.invalid && memberGroup.get('academicId')?.touched" class="error-message"><i class="fas fa-exclamation-circle"></i> A valid numeric ID is required.</div>
          </div>
          <div class="form-group"><label [for]="'academicDegree' + i">Academic Degree</label>
            <select [id]="'academicDegree' + i" formControlName="academicDegree" class="form-control"><option [value]="0">Student</option><option [value]="1">Graduate</option></select>
          </div>
        </div>
        <button type="button" (click)="removeMember(i)" class="remove-item-btn" *ngIf="members.length > 1">&times;</button>
      </div>
      <button type="button" (click)="addMember()" class="btn-add-item"><i class="fas fa-plus"></i> Add Member</button>
    </div>

    <div class="form-card" formArrayName="supervisors">
      <h2 class="card-title">Supervisors</h2>
      <div *ngFor="let supervisorGroup of supervisors.controls; let i = index" [formGroupName]="i" class="array-group">
        <div class="form-group"><label [for]="'supervisorId' + i">Supervisor ID</label><input [id]="'supervisorId' + i" type="number" formControlName="id" class="form-control" [class.is-invalid]="supervisorGroup.get('id')?.invalid && supervisorGroup.get('id')?.touched">
           <div *ngIf="supervisorGroup.get('id')?.invalid && supervisorGroup.get('id')?.touched" class="error-message"><i class="fas fa-exclamation-circle"></i> A valid numeric ID is required.</div>
        </div>
        <button type="button" (click)="removeSupervisor(i)" class="remove-item-btn" *ngIf="supervisors.length > 1">&times;</button>
      </div>
      <button type="button" (click)="addSupervisor()" class="btn-add-item"><i class="fas fa-plus"></i> Add Supervisor</button>
    </div>

    <div class="form-card" formArrayName="evaluators">
      <h2 class="card-title">Evaluators</h2>
      <div *ngFor="let evaluatorGroup of evaluators.controls; let i = index" [formGroupName]="i" class="array-group">
        <div class="form-grid-3">
          <div class="form-group"><label [for]="'evaluatorName' + i">Evaluator Name</label><input [id]="'evaluatorName' + i" formControlName="name" class="form-control" [class.is-invalid]="evaluatorGroup.get('name')?.invalid && evaluatorGroup.get('name')?.touched">
            <div *ngIf="evaluatorGroup.get('name')?.invalid && evaluatorGroup.get('name')?.touched" class="error-message"><i class="fas fa-exclamation-circle"></i> Name is required.</div>
          </div>
          <div class="form-group"><label [for]="'evaluatorDegree' + i">Academic Degree</label>
            <select [id]="'evaluatorDegree' + i" formControlName="academicDegree" class="form-control"><option [value]="0">Lecturer</option><option [value]="1">Professor</option></select>
          </div>
          <div class="form-group"><label [for]="'evaluatorScore' + i">Score</label><input [id]="'evaluatorScore' + i" type="number" formControlName="score" class="form-control" [class.is-invalid]="evaluatorGroup.get('score')?.invalid && evaluatorGroup.get('score')?.touched">
            <div *ngIf="evaluatorGroup.get('score')?.invalid && evaluatorGroup.get('score')?.touched" class="error-message"><i class="fas fa-exclamation-circle"></i> A valid score (0-100) is required.</div>
          </div>
        </div>
        <button type="button" (click)="removeEvaluator(i)" class="remove-item-btn" *ngIf="evaluators.length > 1">&times;</button>
      </div>
      <button type="button" (click)="addEvaluator()" class="btn-add-item"><i class="fas fa-plus"></i> Add Evaluator</button>
    </div>

    <div class="form-actions">
      <button type="button" class="btn-secondary" (click)="onCancel()">Cancel</button>
      <button type="submit" class="btn-primary" [disabled]="projectForm.invalid || isSubmitting">
        <span *ngIf="!isSubmitting"><i class="fas fa-plus"></i> Create Project</span>
        <span *ngIf="isSubmitting"><i class="fas fa-spinner fa-spin"></i> Creating...</span>
      </button>
    </div>
  </form>
</main>
