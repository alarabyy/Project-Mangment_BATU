<!-- src/app/components/report-generator/report-generator.component.html -->
<div class="report-generator-container">
  <header class="page-header">
    <div class="header-content">
      <i class="fas fa-file-invoice header-icon"></i>
      <div>
        <h1>Report Generator</h1>
        <p>Search for projects and generate a professional, printable PDF report with analytics.</p>
      </div>
    </div>
    <div class="search-container">
      <input
        type="text"
        placeholder="Enter search term (e.g., 'AI', 'Web')..."
        class="search-input"
        [(ngModel)]="searchTerm"
        (keyup.enter)="generateReport()">
      <button class="btn btn-primary" (click)="generateReport()" [disabled]="!searchTerm.trim() || (isLoading | async)">
        <i class="fas fa-search"></i> Generate
      </button>
    </div>
  </header>

  <div class="report-page-wrapper">
    <div *ngIf="isLoading | async" class="status-container">
      <div class="loader"></div><p>Searching for projects...</p>
    </div>
    <div *ngIf="error$ | async as errorMsg" class="status-container error">
      <i class="fas fa-exclamation-triangle"></i><p>{{ errorMsg }}</p>
    </div>

    <ng-container *ngIf="!(isLoading | async) && !(error$ | async)">
      <ng-container *ngIf="reportData$ | async as data">
        <div *ngIf="reportGenerated; else prompt" class="report-content-wrapper">
          <div class="report-content" #reportContent>
            <div class="report-header">
              <div class="logo">PMS</div>
              <h1>Project Search Report</h1>
              <div class="meta-info">
                <span><strong>Generated on:</strong> {{ currentDate | date:'fullDate' }}</span>
                <span><strong>Search Term:</strong> "{{ searchTerm }}"</span>
              </div>
            </div>

            <div *ngIf="data.projects && data.projects.length > 0; else noResults">
              <!-- Projects Table -->
              <h2>Search Results</h2>
              <div class="table-responsive">
                <table class="report-table">
                  <thead><tr><th>ID</th><th>Title</th><th>Leader</th><th>Category</th><th>Score</th></tr></thead>
                  <tbody><tr *ngFor="let project of data.projects"><td>{{ project.id }}</td><td>{{ project.title }}</td><td>{{ project.leader?.name || 'N/A' }}</td><td>{{ project.category?.name || 'N/A' }}</td><td>{{ project.score ?? 'N/A' }}</td></tr></tbody>
                </table>
              </div>

              <!-- Analytics Section -->
              <div class="analytics-section">
                <h2>Report Summary & Analytics</h2>
                <div class="kpi-grid">
                  <div class="kpi-item"><span class="kpi-value" #kpiValue [attr.data-value]="data.analytics.totalProjects">0</span><span class="kpi-label">Total Projects Found</span></div>
                  <div class="kpi-item"><span class="kpi-value" #kpiValue [attr.data-value]="data.analytics.averageScore">0</span><span class="kpi-label">Average Score</span></div>
                  <div class="kpi-item"><span class="kpi-value kpi-text">{{ data.analytics.topTechnology }}</span><span class="kpi-label">Most Frequent Technology</span></div>
                  <div class="kpi-item"><span class="kpi-value kpi-text">{{ data.analytics.topTool }}</span><span class="kpi-label">Most Frequent Tool</span></div>
                </div>
                <div class="charts-grid">
                  <div class="chart-container"><h4>Projects by Category</h4><apx-chart [series]="data.categoryChartOptions.series!" [chart]="data.categoryChartOptions.chart!" [labels]="data.categoryChartOptions.labels!" [legend]="data.categoryChartOptions.legend!" [colors]="data.categoryChartOptions.colors"></apx-chart></div>
                  <div class="chart-container"><h4>Projects by Department</h4><apx-chart [series]="data.departmentChartOptions.series!" [chart]="data.departmentChartOptions.chart!" [plotOptions]="data.departmentChartOptions.plotOptions!" [xaxis]="data.departmentChartOptions.xaxis!" [legend]="data.departmentChartOptions.legend!"></apx-chart></div>
                  <div class="chart-container full-width"><h4>Score Distribution</h4><apx-chart [series]="data.scoreDistributionOptions.series!" [chart]="data.scoreDistributionOptions.chart!" [xaxis]="data.scoreDistributionOptions.xaxis!" [title]="data.scoreDistributionOptions.title!" [yaxis]="data.scoreDistributionOptions.yaxis" [grid]="data.scoreDistributionOptions.grid" [plotOptions]="data.scoreDistributionOptions.plotOptions"></apx-chart></div>
                </div>
              </div>
            </div>
            <ng-template #noResults><div class="no-results"><i class="fas fa-folder-open"></i><p>No projects found matching your search term.</p></div></ng-template>
            <div class="report-footer"><p>Page 1 | Confidential Report</p></div>
          </div>
        </div>
        <ng-template #prompt>
          <div class="status-container"><i class="fas fa-search"></i><p>Enter a search term and click "Generate" to create a report.</p></div>
        </ng-template>
      </ng-container>
    </ng-container>
  </div>

  <div class="download-fab" *ngIf="reportGenerated && (reportData$ | async)?.projects?.length">
    <button class="btn btn-download" (click)="downloadPDF()" [disabled]="isDownloading">
      <i class="fas" [ngClass]="isDownloading ? 'fa-spinner fa-spin' : 'fa-download'"></i>
      <span>{{ isDownloading ? 'Generating PDF...' : 'Download PDF' }}</span>
    </button>
  </div>
</div>
