<!-- src/app/components/project/project-details/project-details.component.html -->
<ng-container *ngIf="state$ | async as state">
  <div class="details-container">
    <div *ngIf="state.isLoading" class="status-container">
      <div class="loader"></div> <p>Loading Project Details...</p>
    </div>

    <div *ngIf="state.error && !state.isLoading" class="status-container error-container">
      <i class="fas fa-exclamation-triangle"></i>
      <p>{{ state.error }}</p>
      <a routerLink="/ProjectList" class="btn btn-secondary">Back to List</a>
    </div>

    <div *ngIf="state.project as project" class="project-layout animate-fade-in">
      <!-- Left Column: Gallery & Core Info -->
      <div class="left-column">
        <header class="details-header">
          <h1>{{ project.title }}</h1>
          <div class="header-actions" *ngIf="isProjectLeader(project.leader.id) || authService.getUserRole() === 'admin'">
            <a [routerLink]="['/EditProject', project.id]" class="btn btn-primary"><i class="fas fa-edit"></i> Edit Project</a>
          </div>
        </header>

        <p class="project-description">{{ project.description }}</p>

        <div class="image-gallery-section">
          <div class="main-image-wrapper">
            <img [src]="getMainImageUrl(project)" [alt]="project.title + ' main image'" (error)="onImageError($event)">
          </div>
          <div class="thumbnail-strip" *ngIf="project.images && project.images.length > 1">
            <img *ngFor="let filename of project.images" [src]="imageBaseUrl + filename" alt="thumbnail" (click)="selectImage(filename)" [class.active]="filename === mainImageFilename" (error)="onImageError($event)">
          </div>
        </div>

        <div class="info-card">
          <h3 class="card-title"><i class="fas fa-bullseye"></i> Problem Statement</h3>
          <p>{{ project.problemStatement }}</p>
        </div>

        <div class="info-card">
          <h3 class="card-title"><i class="fas fa-file-alt"></i> Project Documents</h3>
          <ng-container *ngIf="project.documents && project.documents.length > 0; else noDocuments">
            <div class="document-list">
              <a *ngFor="let doc of project.documents" [href]="docBaseUrl + doc" target="_blank" class="doc-item">
                <i class="doc-icon" [ngClass]="getFileIconClass(doc)"></i>
                <span class="doc-name">{{ doc }}</span>
                <i class="fas fa-external-link-alt"></i>
              </a>
            </div>
          </ng-container>
          <ng-template #noDocuments><p class="no-history">No documents have been uploaded for this project.</p></ng-template>
        </div>
      </div>

      <!-- Right Column: All Other Details -->
      <div class="right-column">
        <div class="info-card"><h3 class="card-title"><i class="fas fa-info-circle"></i> Project Information</h3><div class="info-grid"><div class="info-item"><label><i class="fas fa-medal"></i> Score</label><span>{{ project.score ?? 'Not Graded' }}</span></div><div class="info-item"><label><i class="fas fa-calendar-check"></i> Start Date</label><span>{{ project.startDate | date:'longDate' }}</span></div></div></div>
        <div class="info-card"><h3 class="card-title"><i class="fas fa-microchip"></i> Technical Details</h3><div class="tech-list"><h4>Technologies</h4><div class="badges"><span *ngFor="let tech of project.technologies.split(',')" class="badge">{{ tech.trim() }}</span></div></div><div class="tech-list"><h4>Tools Used</h4><div class="badges"><span *ngFor="let tool of project.toolsUsed.split(',')" class="badge">{{ tool.trim() }}</span></div></div></div>
        <div class="info-card"><h3 class="card-title"><i class="fas fa-sitemap"></i> Academic Context</h3><div class="info-grid"><div class="info-item"><label><i class="fas fa-tags"></i> Category</label><span>{{ project.category.name ?? 'N/A' }}</span></div><div class="info-item full-width"><label><i class="fas fa-building"></i> Departments</label><div class="badges"><span *ngFor="let dept of project.department" class="badge secondary">{{ dept.name }}</span></div></div></div></div>
        <div class="info-card" *ngIf="project.patentNumber"><h3 class="card-title"><i class="fas fa-award"></i> Patent Information</h3><div class="info-grid"><div class="info-item"><label><i class="fas fa-hashtag"></i> Patent Number</label><span>{{ project.patentNumber }}</span></div><div class="info-item"><label><i class="fas fa-calendar-alt"></i> Patent Date</label><span>{{ project.patentDate | date:'longDate' }}</span></div></div></div>
        <div class="info-card"><h3 class="card-title"><i class="fas fa-users"></i> Project Team</h3><div class="team-grid"><div class="team-member-card leader"><div class="member-avatar"><i class="fas fa-user-crown"></i></div><div class="member-info"><strong>{{ project.leader.name }}</strong><span>Project Leader</span></div></div><div *ngFor="let supervisor of project.supervisers" class="team-member-card"><div class="member-avatar"><i class="fas fa-user-tie"></i></div><div class="member-info"><strong>{{ supervisor.name }}</strong><span>Supervisor</span></div></div><div *ngFor="let member of project.members" class="team-member-card"><div class="member-avatar"><i class="fas fa-user-graduate"></i></div><div class="member-info"><strong>{{ member.name }}</strong><span>ID: {{member.academicId}}</span></div></div></div></div>
        <div class="info-card"><h3 class="card-title"><i class="fas fa-clipboard-check"></i> Evaluation Committee</h3><div class="team-grid"><div *ngFor="let evaluator of project.evaluators" class="team-member-card"><div class="member-avatar"><i class="fas fa-user-check"></i></div><div class="member-info"><strong>{{ evaluator.name }}</strong><span>Score: {{evaluator.score}}</span></div></div></div></div>

        <div class="info-card">
            <h3 class="card-title"><i class="fas fa-history"></i> Project History</h3>
            <ng-container *ngIf="state.history && state.history.length > 0; else noHistory">
              <ul class="timeline">
                <li *ngFor="let event of state.history" class="timeline-item">
                  <div class="timeline-icon"><i class="fas fa-edit"></i></div>
                  <div class="timeline-content">
                    <div class="timeline-header"><span class="timeline-title">{{ event.fieldName }} Changed</span><span class="timeline-date">{{ event.editedAt | date:'medium' }}</span></div>
                    <p class="timeline-description">from <span class="value old-value">{{ event.oldValue || 'nothing' }}</span> to <span class="value new-value">{{ event.newValue || 'nothing' }}</span></p>
                    <span class="timeline-author">by {{ event.editedByUser.name }}</span>
                  </div>
                </li>
              </ul>
            </ng-container>
            <ng-template #noHistory><p class="no-history">No changes have been recorded for this project yet.</p></ng-template>
        </div>
      </div>
    </div>
  </div>
</ng-container>
