<ng-container *ngIf="state$ | async as state">
  <main class="analytics-container">
    <header class="page-header">
      <div class="header-content">
        <h1>User Intelligence</h1>
        <p>A deep-dive into user behavior, demographics, and activity patterns.</p>
      </div>
      <div class="header-filters">
        <div class="filter-group">
          <label for="role-filter">Role</label>
          <select id="role-filter" (change)="onRoleFilterChange($event)">
            <option value="all">All Roles</option>
            <option value="admin">Admin</option>
            <option value="student">Student</option>
            <option value="doctor">Doctor</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="status-filter">Status</label>
          <select id="status-filter" (change)="onStatusFilterChange($event)">
            <option value="all">All Statuses</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="pending">Pending</option>
          </select>
        </div>
      </div>
    </header>

    <ng-container *ngIf="state.isLoading">
      <div class="analytics-grid skeleton-grid">
        <div class="kpi-card-skeleton" *ngFor="let i of [1,2,3,4]"></div>
        <div class="chart-card-skeleton large"></div>
        <div class="chart-card-skeleton large"></div>
        <div class="chart-card-skeleton full-width"></div>
      </div>
    </ng-container>

    <div *ngIf="state.error && !state.isLoading" class="error-message">
      <p>Error: {{ state.error }}</p>
    </div>

    <ng-container *ngIf="!state.isLoading && !state.error">
      <div *ngIf="filteredUsers$ | async as users">
        <ng-container *ngIf="kpiData$ | async as kpiData">
          <div class="analytics-grid">
            <!-- KPI Cards -->
            <div class="kpi-card">
              <i class="fas fa-users kpi-icon"></i>
              <div class="kpi-content">
                <span class="kpi-value" #kpiValue [attr.data-value]="kpiData.total">0</span>
                <span class="kpi-title">Total Users</span>
              </div>
            </div>
            <div class="kpi-card">
              <i class="fas fa-user-check kpi-icon"></i>
              <div class="kpi-content">
                <!-- FIX: Added attributes for animation consistency -->
                <span class="kpi-value" #kpiValue [attr.data-value]="kpiData.active">0</span>
                <span class="kpi-title">Active Users</span>
              </div>
            </div>
            <div class="kpi-card">
              <i class="fas fa-calendar-alt kpi-icon"></i>
              <div class="kpi-content">
                <span class="kpi-value" #kpiValue [attr.data-value]="kpiData.newLastMonth">0</span>
                <span class="kpi-title">New Last 30 Days</span>
              </div>
            </div>
            <div class="kpi-card">
              <i class="fas fa-user-clock kpi-icon"></i>
              <div class="kpi-content">
                <!-- FIX: Added attributes for animation consistency -->
                <span class="kpi-value" #kpiValue [attr.data-value]="kpiData.inactive">0</span>
                <span class="kpi-title">Inactive Users</span>
              </div>
            </div>

            <!-- Main Charts & Lists -->
            <div class="chart-card large">
              <h3 class="chart-title">Annual Activity Heatmap</h3>
              <div *ngIf="activityHeatmapOptions$ | async as options">
                <apx-chart
                  [series]="options.series"
                  [chart]="options.chart"
                  [plotOptions]="options.plotOptions"
                  [dataLabels]="options.dataLabels"
                  [legend]="options.legend"
                  [yaxis]="options.yaxis"
                  [tooltip]="options.tooltip"
                ></apx-chart>
              </div>
            </div>

            <div class="chart-card large">
              <h3 class="chart-title">User Geodistribution</h3>
              <div *ngIf="geoChartOptions$ | async as options">
                <apx-chart
                  [series]="options.series"
                  [chart]="options.chart"
                  [plotOptions]="options.plotOptions"
                  [xaxis]="options.xaxis"
                  [yaxis]="options.yaxis"
                  [grid]="options.grid"
                  [tooltip]="options.tooltip"
                  [legend]="options.legend"
                  [colors]="options.colors"
                  [dataLabels]="options.dataLabels"
                ></apx-chart>
              </div>
            </div>

            <!-- Data Table will go here in a future step -->
          </div>
        </ng-container>
      </div>
    </ng-container>
  </main>
</ng-container>
